---
// Search component - will be populated with posts data on the client side
---

<!-- Search Modal -->
<div id="search-modal" class="search-modal hidden">
  <div class="search-backdrop"></div>
  <div class="search-container">
    <div class="search-box">
      <div class="search-input-wrapper">
        <svg class="search-icon" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
        </svg>
        <input
          type="text"
          id="search-input"
          class="search-input"
          placeholder="Search posts..."
          autocomplete="off"
          autofocus
        />
        <button id="search-close" class="search-close" aria-label="Close search">
          <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
          </svg>
        </button>
      </div>

      <div id="search-results" class="search-results">
        <div class="search-empty">
          Type to search posts...
        </div>
      </div>
    </div>
  </div>
</div>

<style>
  .search-modal {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    z-index: 100;
    display: flex;
    align-items: flex-start;
    justify-content: center;
    padding-top: 10vh;
  }

  .search-modal.hidden {
    display: none;
  }

  .search-backdrop {
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background-color: rgba(0, 0, 0, 0.5);
    backdrop-filter: blur(4px);
  }

  .search-container {
    position: relative;
    width: 100%;
    max-width: 600px;
    margin: 0 var(--space-md);
  }

  .search-box {
    background-color: var(--color-bg-primary);
    border-radius: var(--radius-lg);
    box-shadow: var(--shadow-lg);
    overflow: hidden;
    border: 1px solid var(--color-border);
  }

  .search-input-wrapper {
    display: flex;
    align-items: center;
    padding: var(--space-md) var(--space-lg);
    border-bottom: 1px solid var(--color-border);
    gap: var(--space-sm);
  }

  .search-icon {
    width: 20px;
    height: 20px;
    color: var(--color-text-tertiary);
    flex-shrink: 0;
  }

  .search-input {
    flex: 1;
    border: none;
    outline: none;
    background: transparent;
    color: var(--color-text-primary);
    font-size: 1rem;
    font-weight: 500;
  }

  .search-input::placeholder {
    color: var(--color-text-tertiary);
  }

  .search-close {
    width: 32px;
    height: 32px;
    border: none;
    background: transparent;
    color: var(--color-text-secondary);
    cursor: pointer;
    border-radius: var(--radius-md);
    transition: all var(--transition-fast);
    display: flex;
    align-items: center;
    justify-content: center;
    flex-shrink: 0;
  }

  .search-close:hover {
    background-color: var(--color-bg-secondary);
    color: var(--color-text-primary);
  }

  .search-close svg {
    width: 20px;
    height: 20px;
  }

  .search-results {
    max-height: 60vh;
    overflow-y: auto;
  }

  :global(.search-empty),
  :global(.search-no-results) {
    padding: var(--space-2xl) var(--space-lg) !important;
    text-align: center !important;
    color: var(--color-text-tertiary) !important;
  }

  :global(.search-result-item) {
    padding: var(--space-md) var(--space-lg);
    border-bottom: 1px solid var(--color-border);
    cursor: pointer;
    transition: background-color var(--transition-fast);
    text-decoration: none;
    color: inherit;
    display: block;
  }

  :global(.search-result-item:last-child) {
    border-bottom: none;
  }

  :global(.search-result-item:hover) {
    background-color: var(--color-bg-secondary);
  }

  :global(.search-result-title) {
    font-weight: 600;
    color: var(--color-text-primary);
    margin-bottom: var(--space-xs);
    font-size: 1rem;
  }

  :global(.search-result-meta) {
    display: flex;
    align-items: center;
    gap: var(--space-sm);
    font-size: 0.75rem;
    color: var(--color-text-tertiary);
    margin-bottom: var(--space-xs);
  }

  :global(.search-result-category) {
    padding: 2px var(--space-xs);
    background-color: var(--color-accent-light);
    color: var(--color-accent-primary);
    border-radius: var(--radius-sm);
    font-weight: 600;
  }

  :global(.search-result-description) {
    font-size: 0.875rem;
    color: var(--color-text-secondary);
    line-height: 1.5;
    display: -webkit-box;
    -webkit-line-clamp: 2;
    -webkit-box-orient: vertical;
    overflow: hidden;
  }
</style>

<script>
  // Search functionality
  let posts = [];

  // Fetch all posts
  async function loadPosts() {
    try {
      // In a real implementation, you'd fetch this from an API or include it in the page
      // For now, we'll fetch from the current page's window object if available
      if (window.allPosts) {
        posts = window.allPosts;
      }
    } catch (error) {
      console.error('Failed to load posts:', error);
    }
  }

  // Search posts
  function searchPosts(query) {
    if (!query.trim()) return [];

    const lowerQuery = query.toLowerCase();
    return posts.filter(post => {
      const title = post.title.toLowerCase();
      const description = (post.description || '').toLowerCase();
      const category = (post.category || '').toLowerCase();

      return title.includes(lowerQuery) ||
             description.includes(lowerQuery) ||
             category.includes(lowerQuery);
    }).slice(0, 10); // Limit to 10 results
  }

  // Render search results
  function renderResults(results, query) {
    const resultsContainer = document.getElementById('search-results');
    if (!resultsContainer) return;

    // If no query, show empty state
    if (!query || !query.trim()) {
      resultsContainer.innerHTML = `<div class="search-empty">Type to search posts...</div>`;
      return;
    }

    // If query exists but no results
    if (results.length === 0) {
      resultsContainer.innerHTML = `<div class="search-no-results">No posts found. Try different keywords.</div>`;
      return;
    }

    // Show results
    resultsContainer.innerHTML = results.map(post => {
      const date = new Date(post.date).toLocaleDateString('ko-KR', {
        year: 'numeric',
        month: 'short',
        day: 'numeric'
      });

      return `
        <a href="/blog/posts/${post.slug}/" class="search-result-item">
          <div class="search-result-title">${escapeHtml(post.title)}</div>
          <div class="search-result-meta">
            <span>${date}</span>
            ${post.category ? `<span class="search-result-category">${escapeHtml(post.category)}</span>` : ''}
          </div>
          ${post.description ? `<div class="search-result-description">${escapeHtml(post.description)}</div>` : ''}
        </a>
      `;
    }).join('');
  }

  // Escape HTML to prevent XSS
  function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
  }

  // Initialize search
  function initSearch() {
    const modal = document.getElementById('search-modal');
    const input = document.getElementById('search-input');
    const closeBtn = document.getElementById('search-close');
    const backdrop = modal?.querySelector('.search-backdrop');

    if (!modal || !input || !closeBtn) return;

    // Close modal function
    const closeModal = () => {
      modal.classList.add('hidden');
      input.value = '';
      document.getElementById('search-results')!.innerHTML = `<div class="search-empty">Type to search posts...</div>`;
    };

    // Close on backdrop click
    backdrop?.addEventListener('click', closeModal);

    // Close on button click
    closeBtn.addEventListener('click', closeModal);

    // Close on Escape key
    document.addEventListener('keydown', (e) => {
      if (e.key === 'Escape' && !modal.classList.contains('hidden')) {
        closeModal();
      }
    });

    // Search on input
    let debounceTimer;
    input.addEventListener('input', (e) => {
      clearTimeout(debounceTimer);
      debounceTimer = setTimeout(() => {
        const query = (e.target as HTMLInputElement).value;
        const results = searchPosts(query);
        renderResults(results, query);
      }, 300);
    });

    // Load posts on init
    loadPosts();
  }

  // Initialize when DOM is ready
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', initSearch);
  } else {
    initSearch();
  }

  // Export function to open search modal
  (window as any).openSearchModal = () => {
    const modal = document.getElementById('search-modal');
    const input = document.getElementById('search-input');
    if (modal && input) {
      modal.classList.remove('hidden');
      setTimeout(() => input.focus(), 100);
    }
  };
</script>
